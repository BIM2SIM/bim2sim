# PluginOpenFOAM

(HowtoInstallOF)=
## How to install?

### Step by step

To install `PluginOpenFOAM`: you need to do the following
(in the root directory of the repo, here is the pyproject.toml file)
```shell
pip install -e '.[PluginOpenFOAM]'
```
The [bim2sim core installation](coreInstalltion) needs to be done before. 
PluginE+ as well?

### Trouble Shooting
For python > 3.9: make sure that the correct geomeppy is installed (using requirements.txt in the plugin): in this fork of geomeppy, we fixed the imports working from python >= 3.10: https://github.com/BIM2SIM/geomeppy/tree/fix_dependencies

### Test install


## Structure of the plugin

The following figure shows the structure of the OpenFOAM plugin. Here you see 
which tasks are used and how they are combined.
<!--- 
the following code is pasted from the a file from /bim2sim/docs/source/img/dynamic/plugindiagram
this figure is generated by the function generate_plugin_structure_fig in file template_mermaid.py
-->

(Hint: firefox has issue display mermaid figures completely, for more infos see
issue [#766](https://github.com/BIM2SIM/bim2sim/issues/766))
```{mermaid}
---
title: plugin openfoam
---
flowchart TB
    
subgraph taskLoadIFC["task LoadIFC"]
 subgraph "" 

  tLoadIFC["bim2sim > tasks > common >  
 LoadIFC"]
  extLoadIFC(" Load all IFC files from PROJECT. " )
 end

stateLoadIFC[("state
 (reads/touches)")]
    
tLoadIFC -- ifc_files --> stateLoadIFC

end
    
subgraph taskCreateElementsOnIfcTypes["task CreateElementsOnIfcTypes"]
 subgraph "" 

  tCreateElementsOnIfcTypes["bim2sim > tasks > common >  
 CreateElementsOnIfcTypes"]
  extCreateElementsOnIfcTypes(" Create bim2sim elements based on information of
IFC types. " )
 end

stateCreateElementsOnIfcTypes[("state
 (reads/touches)")]
    
stateCreateElementsOnIfcTypes -- ifc_files --> tCreateElementsOnIfcTypes

tCreateElementsOnIfcTypes -- elements, _initial_elements, ifc_files --> stateCreateElementsOnIfcTypes

end
    
subgraph taskCreateSpaceBoundaries["task CreateSpaceBoundaries"]
 subgraph "" 

  tCreateSpaceBoundaries["bim2sim > tasks > bps >  
 CreateSpaceBoundaries"]
  extCreateSpaceBoundaries(" Create space boundary elements from ifc. " )
 end

stateCreateSpaceBoundaries[("state
 (reads/touches)")]
    
stateCreateSpaceBoundaries -- ifc_files, elements --> tCreateSpaceBoundaries
direction RL
end
    
subgraph taskAddSpaceBoundaries2B["task AddSpaceBoundaries2B"]
 subgraph "" 

  tAddSpaceBoundaries2B["bim2sim > tasks > bps >  
 AddSpaceBoundaries2B"]
  extAddSpaceBoundaries2B(" Fill gaps in set of space boundary per space with
2B space boundaries. " )
 end

stateAddSpaceBoundaries2B[("state
 (reads/touches)")]
    
stateAddSpaceBoundaries2B -- elements --> tAddSpaceBoundaries2B

tAddSpaceBoundaries2B -- elements --> stateAddSpaceBoundaries2B

end
    
subgraph taskCorrectSpaceBoundaries["task CorrectSpaceBoundaries"]
 subgraph "" 

  tCorrectSpaceBoundaries["bim2sim > tasks > bps >  
 CorrectSpaceBoundaries"]
  extCorrectSpaceBoundaries(" Advanced geometric preprocessing for Space
Boundaries. " )
 end

stateCorrectSpaceBoundaries[("state
 (reads/touches)")]
    
stateCorrectSpaceBoundaries -- elements --> tCorrectSpaceBoundaries
direction RL
end
    
subgraph taskCreateRelations["task CreateRelations"]
 subgraph "" 

  tCreateRelations["bim2sim > tasks > common >  
 CreateRelations"]
  extCreateRelations(" Relations of elements, run() method holds detailed
information. " )
 end

stateCreateRelations[("state
 (reads/touches)")]
    
stateCreateRelations -- elements --> tCreateRelations
direction RL
end
    
subgraph taskDisaggregationCreationAndTypeCheck["task DisaggregationCreationAndTypeCheck"]
 subgraph "" 

  tDisaggregationCreationAndTypeCheck["bim2sim > tasks > bps >  
 DisaggregationCreationAndTypeCheck"]
  extDisaggregationCreationAndTypeCheck(" Disaggregation of elements, run() method holds
detailed information. " )
 end

stateDisaggregationCreationAndTypeCheck[("state
 (reads/touches)")]
    
stateDisaggregationCreationAndTypeCheck -- elements --> tDisaggregationCreationAndTypeCheck
direction RL
end
    
subgraph taskEnrichMaterial["task EnrichMaterial"]
 subgraph "" 

  tEnrichMaterial["bim2sim > tasks > bps >  
 EnrichMaterial"]
  extEnrichMaterial(" Enriches material properties that were recognized
as invalid LOD. " )
 end

stateEnrichMaterial[("state
 (reads/touches)")]
    
stateEnrichMaterial -- elements --> tEnrichMaterial
direction RL
end
    
subgraph taskEnrichUseConditions["task EnrichUseConditions"]
 subgraph "" 

  tEnrichUseConditions["bim2sim > tasks > bps >  
 EnrichUseConditions"]
  extEnrichUseConditions(" Enriches Use Conditions of thermal zones based on
decisions and translation of zone names. " )
 end

stateEnrichUseConditions[("state
 (reads/touches)")]
    
stateEnrichUseConditions -- elements --> tEnrichUseConditions
direction RL
end
    
subgraph taskWeather["task Weather"]
 subgraph "" 

  tWeather["bim2sim > tasks > common >  
 Weather"]
  extWeather(" Task to get the weather file for later simulation. " )
 end

stateWeather[("state
 (reads/touches)")]
    
stateWeather -- elements --> tWeather

tWeather -- weather_file --> stateWeather

end
    
subgraph taskCreateIdf["task CreateIdf"]
 subgraph "" 

  tCreateIdf["bim2sim > plugins > PluginEnergyPlus > 
bim2sim_energyplus > task >  
 CreateIdf"]
  extCreateIdf(" Create an EnergyPlus Input file. " )
 end

stateCreateIdf[("state
 (reads/touches)")]
    
stateCreateIdf -- elements, weather_file --> tCreateIdf

tCreateIdf -- idf, sim_results_path --> stateCreateIdf

end
    
subgraph taskComfortSettings["task ComfortSettings"]
 subgraph "" 

  tComfortSettings["bim2sim > plugins > PluginComfort > 
bim2sim_comfort > task >  
 ComfortSettings"]
  extComfortSettings("  Create Comfort Settings for an EnergyPlus Input
file. " )
 end

stateComfortSettings[("state
 (reads/touches)")]
    
stateComfortSettings -- elements, idf, sim_results_path --> tComfortSettings

tComfortSettings -- idf --> stateComfortSettings

end
    
subgraph taskSerializeElements["task SerializeElements"]
 subgraph "" 

  tSerializeElements["bim2sim > tasks > common >  
 SerializeElements"]
  extSerializeElements(" Serialize element structure, run() method holds
detailed information. " )
 end

stateSerializeElements[("state
 (reads/touches)")]
    
stateSerializeElements -- elements --> tSerializeElements

tSerializeElements -- serialized_elements --> stateSerializeElements

end
    
subgraph taskRunEnergyPlusSimulation["task RunEnergyPlusSimulation"]
 subgraph "" 

  tRunEnergyPlusSimulation["bim2sim > plugins > PluginEnergyPlus > 
bim2sim_energyplus > task >  
 RunEnergyPlusSimulation"]
  extRunEnergyPlusSimulation(" Run EnergyPlus simulation. " )
 end

stateRunEnergyPlusSimulation[("state
 (reads/touches)")]
    
stateRunEnergyPlusSimulation -- idf, sim_results_path --> tRunEnergyPlusSimulation
direction RL
end
    
subgraph taskInitializeOpenFOAMSetup["task InitializeOpenFOAMSetup"]
 subgraph "" 

  tInitializeOpenFOAMSetup["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 InitializeOpenFOAMSetup"]
  extInitializeOpenFOAMSetup(" This ITask initializes the OpenFOAM Setup. " )
 end

stateInitializeOpenFOAMSetup[("state
 (reads/touches)")]
    
tInitializeOpenFOAMSetup -- openfoam_case --> stateInitializeOpenFOAMSetup

end
    
subgraph taskCreateOpenFOAMGeometry["task CreateOpenFOAMGeometry"]
 subgraph "" 

  tCreateOpenFOAMGeometry["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 CreateOpenFOAMGeometry"]
  extCreateOpenFOAMGeometry(" This ITask initializes the OpenFOAM Geometry. " )
 end

stateCreateOpenFOAMGeometry[("state
 (reads/touches)")]
    
stateCreateOpenFOAMGeometry -- openfoam_case, elements --> tCreateOpenFOAMGeometry

tCreateOpenFOAMGeometry -- openfoam_case, openfoam_elements --> stateCreateOpenFOAMGeometry

end
    
subgraph taskAddOpenFOAMComfort["task AddOpenFOAMComfort"]
 subgraph "" 

  tAddOpenFOAMComfort["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 AddOpenFOAMComfort"]
  extAddOpenFOAMComfort(" This ITask adds the openfoam comfort settings. " )
 end

stateAddOpenFOAMComfort[("state
 (reads/touches)")]
    
stateAddOpenFOAMComfort -- openfoam_case --> tAddOpenFOAMComfort
direction RL
end
    
subgraph taskCreateOpenFOAMMeshing["task CreateOpenFOAMMeshing"]
 subgraph "" 

  tCreateOpenFOAMMeshing["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 CreateOpenFOAMMeshing"]
  extCreateOpenFOAMMeshing(" This ITask initializes the OpenFOAM Meshing. " )
 end

stateCreateOpenFOAMMeshing[("state
 (reads/touches)")]
    
stateCreateOpenFOAMMeshing -- openfoam_case, openfoam_elements --> tCreateOpenFOAMMeshing

tCreateOpenFOAMMeshing -- openfoam_case, openfoam_elements --> stateCreateOpenFOAMMeshing

end
    
subgraph taskSetOpenFOAMBoundaryConditions["task SetOpenFOAMBoundaryConditions"]
 subgraph "" 

  tSetOpenFOAMBoundaryConditions["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 SetOpenFOAMBoundaryConditions"]
  extSetOpenFOAMBoundaryConditions(" This ITask initializes the OpenFOAM Setup. " )
 end

stateSetOpenFOAMBoundaryConditions[("state
 (reads/touches)")]
    
stateSetOpenFOAMBoundaryConditions -- openfoam_elements, openfoam_case --> tSetOpenFOAMBoundaryConditions

tSetOpenFOAMBoundaryConditions -- openfoam_case, openfoam_elements --> stateSetOpenFOAMBoundaryConditions

end
    
subgraph taskRunOpenFOAMMeshing["task RunOpenFOAMMeshing"]
 subgraph "" 

  tRunOpenFOAMMeshing["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 RunOpenFOAMMeshing"]
  extRunOpenFOAMMeshing(" This ITask runs the openfoam meshing on linux
systems. " )
 end

stateRunOpenFOAMMeshing[("state
 (reads/touches)")]
    
stateRunOpenFOAMMeshing -- openfoam_case --> tRunOpenFOAMMeshing
direction RL
end
    
subgraph taskRunOpenFOAMSimulation["task RunOpenFOAMSimulation"]
 subgraph "" 

  tRunOpenFOAMSimulation["bim2sim > plugins > PluginOpenFOAM > 
bim2sim_openfoam > task >  
 RunOpenFOAMSimulation"]
  extRunOpenFOAMSimulation(" This ITask runs the openfoam simulation on linux
systems. " )
 end

stateRunOpenFOAMSimulation[("state
 (reads/touches)")]
    
stateRunOpenFOAMSimulation -- openfoam_case --> tRunOpenFOAMSimulation
direction RL
end
    taskLoadIFC --> taskCreateElementsOnIfcTypes 
taskCreateElementsOnIfcTypes --> taskCreateSpaceBoundaries 
taskCreateSpaceBoundaries --> taskAddSpaceBoundaries2B 
taskAddSpaceBoundaries2B --> taskCorrectSpaceBoundaries 
taskCorrectSpaceBoundaries --> taskCreateRelations 
taskCreateRelations --> taskDisaggregationCreationAndTypeCheck 
taskDisaggregationCreationAndTypeCheck --> taskEnrichMaterial 
taskEnrichMaterial --> taskEnrichUseConditions 
taskEnrichUseConditions --> taskWeather 
taskWeather --> taskCreateIdf 
taskCreateIdf --> taskComfortSettings 
taskComfortSettings --> taskSerializeElements 
taskSerializeElements --> taskRunEnergyPlusSimulation 
taskRunEnergyPlusSimulation --> taskInitializeOpenFOAMSetup 
taskInitializeOpenFOAMSetup --> taskCreateOpenFOAMGeometry 
taskCreateOpenFOAMGeometry --> taskAddOpenFOAMComfort 
taskAddOpenFOAMComfort --> taskCreateOpenFOAMMeshing 
taskCreateOpenFOAMMeshing --> taskSetOpenFOAMBoundaryConditions 
taskSetOpenFOAMBoundaryConditions --> taskRunOpenFOAMMeshing 
taskRunOpenFOAMMeshing --> taskRunOpenFOAMSimulation 
```

This figure is generated by the script template_mermaid.py (see [Visualization of bim2sim plugin structure](genVisPlugins)).

## How to create a project?

## How to load an IFC file?

## How to configure my project?

### Simulation settings

### Configuration file

### Default tasks

### Additional templates

## How to run the project?

## How to run the simulation?

## How to analyze the project?

### What kind of results exist?
### What programs/tools to use for further analysis?


#TODO
Copy to correct positions:

[Go to OpenFOAM specific tasks](OpenFOAM_specific_tasks)
[Go to OpenFOAMSimSettings](OpenFOAM`_sim_settings)

The Plugin EnergyPlus exports the preprocessed IFC data to en EnergyPlus 
Input file (idf). This Plugin contains EnergyPlus specific modifications of 
the geometry and further enrichment for the export. General simulation 
control settings are set here as well as the output variables.

The Plugin consists of multiple individual tasks that are executed 
consecutively. The default tasks are defined in the PluginEnergyPlus class. 
These tasks can be split in two main blocks: general preparation tasks that 
are used for both BPS workflows (TEASER and EnergyPlus) and EnergyPlus 
specific tasks.

* general tasks (common and BPS-specific):
  * ???
* OpenFOAM specific tasks:
  * [IfcValidation](ep_ifc_valid)
  * [EPGeomPreprocessing](ep_geom_preproc)
  * [AddSpaceBoundaries2B](ep_add_2b_sbs)
  * [WeatherEnergyPlus](ep_set_weather)
  * [CreateIdf](ep_create_idf_for_export)
  * [IdfPostprocessing](ep_postprocess)
  * [ExportIdfForCfd](ep_cfd_export)
  * [RunEnergyPlusSimulation](ep_run_sim)

(OpenFOAM_specific_tasks)=
## OpenFOAM specific tasks

### Validation of the IFC file 
(ep_ifc_valid)=
[Go to IfcValidation](IfcValidation)

The EnergyPlus specific tasks start with an EnergyPlus specific validation 
of the space boundaries provided by the IFC file. This validation algorihtm 
is included in the default workflow to give an insight in the quality of the 
provided IFC.

### Geometric Preprocessing for EnergyPlus Export
(ep_geom_preproc)=
[Go to EPGeomPreprocessing](EPGeomPreprocessing)

The preprocessed geometry and material needs an additional preprocessing to 
cover all requirements for the EnergyPlus export. This is done in the 
[EPGeomPreprocessing](EPGeomPreprocessing). The space boundaries which are 
further used to model the building geometry are [added](add_bounds_to_elements) 
to the elements. Minor geometric displacements are fixed by 
[moving children to their parents](move_children_to_parents). This covers all 
cases, where opening space boundaries are displaced by the thickness of the wall.
The surface orientation is [fixed](fix_surface_orientation) if needed 
(all surface normals are supposed to point outwards the relating space). To
improve shading calculations and remove inner loops from surfaces, 
[non-convex space boundaries can be split up](split_non_convex_bounds). Similarly,
[shadings can be added and split if needed](add_and_split_bounds_for_shadings). 

Use the [settings](settings) to decide if boundaries should be split up and
if shadings should be added.

### Add 2b Space Boundaries
(ep_add_2b_sbs)=
[Go to AddSpaceBoundaries2B](AddSpaceBoundaries2B)

Space Boundaries of type 2b can be added here if gaps are located in the 
provided set of space boundaries. The resulting set of space boundaries
then forms a watertight model that can be further used for other simulation
purposes such as [CFD export](ExportIdfForCfd).

### Set the Weather File
(ep_set_weather)=
[Go to WeatherEnergyPlus](WeatherEnergyPlus)

Set the Weather File for the EnergyPlus Simulation. 

### Initialize and Export the EnergyPlus IDF File 
(ep_create_idf_for_export)=
[Go to CreateIdf](CreateIdf)

Write all preprocessed geometric data, materials, and boundary conditions
to an EnergyPlus input file (IDF). 

### IDF Postprocessing
(ep_postprocess)=
[Go to IdfPostprocessing](IdfPostprocessing)

Export data to csv. Some modifications may be required to meet your 
individual postprocessing needs here. 

### Export IDF Geometry for CFD Processing
(ep_cfd_export)=
[Go to ExportIdfForCfd](ExportIdfForCfd)

Use the [settings](settings) to specify, if the IDF geometry should be
converted to .stl for further use in CFD applications. 

### Run EnergyPlus Simulation
(ep_run_sim)=
[Go to RunEnergyPlusSimulation](RunEnergyPlusSimulation)

Run the EnergyPlus simulation. Use the [settings](settings) for further
runtime specifications. 


## EnergyPlusSimSettings

EnergyPlus has its own set of EnergyPlus specific 
[Simulation Settings](simulation_setting) that can be found here:

[Go to EnergyPlusSimSettings](EnergyPlus_sim_settings)
