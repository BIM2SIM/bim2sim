.test-default: &test-default
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_PIPELINE_SOURCE != "merge_request_event"'
      changes:
        - bim2sim/**/*.py
        - .gitlab-ci.yml
    - if: '$CI_COMMIT_REF_NAME == "main"'
      changes:
        - bim2sim/**/*.py
        - .gitlab-ci.yml


.test-mr: &test-mr
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - bim2sim/**/*.py
        - .gitlab-ci.yml

stages:
  - test

test_AixLib:
  <<: *test-default
  image: $CI_REGISTRY/environment:aixlib
  stage: test
  services:
   - name: docker:24.0.5-dind
     variables:
  before_script:
    - pip install coverage
    - pip install coverage-badge
    # reinstall requirements to test current branch status
    - pip install -r bim2sim/plugins/PluginAixLib/requirements.txt
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - python /bim2sim-coding/test/resources/dl_test_resources.py --domain=hydraulic --force_new
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginAixLib/test/integration
    - coverage report -i


test_AixLib-mr:
  <<: *test-mr
  image: $CI_REGISTRY/environment:aixlib
  stage: test
  services:
    - name: docker:24.0.5-dind
      variables:
  before_script:
    - pip install coverage
    - pip install coverage-badge
    # reinstall requirements to test current branch status
    - pip install -r bim2sim/plugins/PluginAixLib/requirements.txt
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - python /bim2sim-coding/test/resources/dl_test_resources.py --domain=hydraulic --force_new
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginAixLib/test/integration
    - coverage report -i
