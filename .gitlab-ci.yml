stages:
  - build
  - Test Base
  - Test Plugin
  - Test Regression
  - doc
  - code_quality
  - release
  - deploy

variables:
  # TODO variable inside variable seems not be working on our gitlab instance,
  # see post below, therefore use hardcoded image here for sphinx job
  # https://stackoverflow.com/questions/67005507/variable-inside-variable-gitlab-ci
  PYTHON_VERSION: "registry.git.rwth-aachen.de/ebc/ebc_all/github_ci/bim2sim/bim2sim:py3.11-occ7.7.0"
#  PYTHON_VERSION: "${CI_REGISTRY}/environment:development"
  GIT_SUBMODULE_STRATEGY: recursive
  GH_REPO_URL: "git@github.com:BIM2SIM/bim2sim.git"
  GH_PAGES_URL: "https://bim2sim.github.io/${CI_PROJECT_NAME}/"
  TEST_ENGINE: "unittest"
  TEST_PATH: test

include:
  - project: 'EBC/EBC_all/gitlab_ci/templates'
    file: 'python/code-quality/pylint.gitlab-ci.yml'
  - project: 'EBC/EBC_all/gitlab_ci/templates'
    file: 'python/doc/sphinxdoc.gitlab-ci.yml'
  - project: 'EBC/EBC_all/gitlab_ci/templates'
    file: 'pages/gh-pages.gitlab-ci.yml'
  - 'ci/builds_releases.gitlab-ci.yml'

# Pre setup environment for included templates
.install_local_repository:
  script:
    # if stage is doc, we need to install documentation specific dependencies
    - eval "$(micromamba shell hook --shell bash)"
    - micromamba activate base
    - pip install -e .[docu,PluginTEASER,PluginEnergyPlus,PluginAixLib,PluginCFD,PluginHKESim,PluginLCA,PluginComfort,PluginOpenFOAM]

# Tests
.test_template_base: &test_template_base
  stage: Test Base
  before_script:
    - eval "$(micromamba shell hook --shell bash)"
    - micromamba activate base
  script:
    - mkdir -p ~/bim2sim-coding/
    - mv ./* ~/bim2sim-coding/
    - cd ~/bim2sim-coding
    - pip install -e .[test]
    - export BIM2SIM_LOG_LEVEL=ERROR
    - |
      if [ "$COVERAGE" = "true" ]; then
        coverage run -m unittest discover ~/bim2sim-coding/test
        mkdir -p /builds/EBC/EBC_all/github_ci/bim2sim/$CI_COMMIT_REF_NAME/coverage
        coverage html -d /builds/EBC/EBC_all/github_ci/bim2sim/$CI_COMMIT_REF_NAME/coverage
        coverage-badge -o /builds/EBC/EBC_all/github_ci/bim2sim/$CI_COMMIT_REF_NAME/coverage/badge.svg
      else
        python -m unittest discover ~/bim2sim-coding/test
      fi
    - ls -la
  artifacts:
    paths:
      - $CI_COMMIT_REF_NAME/coverage
    expire_in: 2 hrs


.test_template_plugin_integration: &test_template_plugin_integration
  stage: Test Plugin
  before_script:
    - eval "$(micromamba shell hook --shell bash)"
    - micromamba activate base
  script:
    - mkdir -p ~/bim2sim-coding/
    - mv ./* ~/bim2sim-coding/
    - cd ~/bim2sim-coding
    - pip install -e .[test]
    - pip install -e .[$plugin]
    - export BIM2SIM_LOG_LEVEL=ERROR
    # run coverage for unit and integration tests if they exist
    - |
      plugin_test_dir=~/bim2sim-coding/bim2sim/plugins/${plugin}/test
      if [ -d "${plugin_test_dir}/unit" ] || [ -d "${plugin_test_dir}/integration" ]; then
        if [ -d "${plugin_test_dir}/unit" ]; then
          echo "Running unit tests..."
          coverage run --source=~/bim2sim-coding/bim2sim/plugins/${plugin} -m unittest discover -v ${plugin_test_dir}/unit
        fi
        if [ -d "${plugin_test_dir}/integration" ]; then
          echo "Running integration tests..."
          coverage run --append --source=~/bim2sim-coding/bim2sim/plugins/${plugin} -m unittest discover -v ${plugin_test_dir}/integration
        fi
      else
        echo "No unit or integration test directories found."
        exit 1
      fi
.test_template_plugin_regression: &test_template_plugin_regression
  stage: Test Regression
  before_script:
    - eval "$(micromamba shell hook --shell bash)"
    - micromamba activate base
  script:
    - mkdir -p ~/bim2sim-coding/
    - mv ./* ~/bim2sim-coding/
    - cd ~/bim2sim-coding
    - pip install -e .[test]
    - pip install -e .[$plugin]
    - export BIM2SIM_LOG_LEVEL=ERROR
    # perform prepare_regression_tests if it exists
    - |
      if [ -f ~/bim2sim-coding/bim2sim/plugins/${plugin}/test/regression/prepare_regression_tests.py ]; then
        python ~/bim2sim-coding/bim2sim/plugins/${plugin}/test/regression/prepare_regression_tests.py
      else
        echo "Skipping regression test preparation for ${plugin}: File not found"
      fi
    # for EP image  create Minimal.idf file
    - |
      if [[ "$CI_JOB_IMAGE" == *"energyplus"* ]]; then
        cat ~/bim2sim-coding/bim2sim/plugins/PluginEnergyPlus/data/Minimal.idf
      fi
    # use  xvfb-run -n 77  command if dymola image is used
    # use set +e to make sure the pipeline does not stop when the job returns exit code 1
    - |
      set +e
      if [[ "$CI_JOB_IMAGE" == *"dymola"* ]]; then
        xvfb-run -n 77 coverage run -m unittest discover ~/bim2sim-coding/bim2sim/plugins/${plugin}/test/regression
      else
        coverage run -m unittest discover ~/bim2sim-coding/bim2sim/plugins/${plugin}/test/regression
      fi
      test_exit_code=$?
      set -e
    - mkdir -p /builds/EBC/EBC_all/github_ci/bim2sim/logs/
    - cp *.log /builds/EBC/EBC_all/github_ci/bim2sim/logs/ || true
    - exit $test_exit_code
  artifacts:
    when: always
    paths:
      - logs/*

# All tests are done with the dev image, as the code in fresh installed anyway, so only the micromamba environment and the occ version can change between dev and main
# Unit tests for base
py3.10:
  <<: *test_template_base
  image: $CI_REGISTRY/bim2sim:py3.10-occ7.7.0
  variables:
    PYTHON_VERSION: "3.10"
    COVERAGE: "false"

py3.11:
  <<: *test_template_base
  image: $CI_REGISTRY/bim2sim:py3.11-occ7.7.0
  variables:
    PYTHON_VERSION: "3.11"
    COVERAGE: "true"

# Integration tests
PluginTEASER:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.10-occ7.7.0
  variables:
    plugin: "PluginTEASER"

PluginTEASER:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.11-occ7.7.0
  variables:
    plugin: "PluginTEASER"

PluginAixLib:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.10-occ7.7.0
  variables:
    plugin: "PluginAixLib"

PluginAixLib:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.11-occ7.7.0
  variables:
    plugin: "PluginAixLib"

PluginEnergyPlus:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginEnergyPlus"

PluginEnergyPlus:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginEnergyPlus"

PluginHKESim:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.10-occ7.7.0
  variables:
    plugin: "PluginHKESim"

PluginHKESim:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.11-occ7.7.0
  variables:
    plugin: "PluginHKESim"

PluginLCA:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.10-occ7.7.0
  variables:
    plugin: "PluginLCA"

PluginLCA:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:py3.11-occ7.7.0
  variables:
    plugin: "PluginLCA"

PluginComfort:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginComfort"

PluginComfort:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginComfort"

PluginOpenFOAM:py3.10:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginOpenFOAM"

PluginOpenFOAM:py3.11:
  <<: *test_template_plugin_integration
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginOpenFOAM"

# Regression tests
PluginTEASER_reg:py3.10:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:dymola2022-py3.10
  variables:
    plugin: "PluginTEASER"

PluginTEASER_reg:py3.11:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:dymola2022-py3.11
  variables:
    plugin: "PluginTEASER"

PluginEnergyPlus_reg:py3.10:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginEnergyPlus"

PluginEnergyPlus_reg:py3.11:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginEnergyPlus"

PluginComfort_reg:py3.10:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginComfort"

PluginComfort_reg:py3.11:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginComfort"

PluginOpenFOAM_reg:py3.10:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus-py3.10
  variables:
    plugin: "PluginOpenFOAM"

PluginOpenFOAM_reg:py3.11:
  <<: *test_template_plugin_regression
  image: $CI_REGISTRY/bim2sim:energyplus9.4.0-py3.11
  variables:
    plugin: "PluginOpenFOAM"
