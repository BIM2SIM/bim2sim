stages:
  - build_docker_base
  - test_docker_base
  - release_docker_base
  - build_docker_plugin
  - test_docker_plugin
  - release_docker_plugin
  - build_docker_total
  - test_docker_total
  - release_docker_total

variables:
  BIM2SIM_NAME:  "bim2sim"
  BIM2SIM_FLAG: ""
  BIM2SIM_VERSION: 0.1.0
  # [Images]
  TEST_IMAGE: ${CI_REGISTRY}/environment:${IMAGE_NAME}_test
  RELEASE_IMAGE: ${CI_REGISTRY}/environment:${IMAGE_NAME}


.docker_build:
  image: docker@sha256:c8bb6fa5388b56304dd770c4bc0478de81ce18540173b1a589178c0d31bfce90
  services:
    - name: docker:18.09.7-dind
      command: [ "--mtu=1440" ]
  before_script:
    - docker login -u $CI_DEPLOY_TOKEN_USERNAME -p $CI_DEPLOY_TOKEN_PASSWORD $CI_REGISTRY_LOGIN
  script:
    - docker build --pull --build-arg BIM2SIM_FLAG=${BIM2SIM_FLAG} --build-arg BIM2SIM_NAME=${BIM2SIM_NAME} --build-arg BIM2SIM_VERSION=${BIM2SIM_VERSION} -t ${TEST_IMAGE} -f ${DOCKERPATH} .
    - docker images
    - docker push ${TEST_IMAGE}

.docker_build_rules:main:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_main/
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_docker_main/
      when: on_success

.docker_build_rules:dev:
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_dev/
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_docker_dev/
      when: on_success

.docker_build_rules:nightly:
  rules:
    - if: $CI_COMMIT_BRANCH == "development" && $CI_COMMIT_MESSAGE =~ /nightly_build_dev/
      when: on_success

# [build base bim2sim docker image]

docker_build_bim2sim:base:main:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "base"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_main/
      when: on_success

docker_build_bim2sim:base:dev:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "base_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_dev/
      when: on_success

docker_build_bim2sim:base:nightly:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "base_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Test base bim2sim]

.test_base:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/R6K1H5Z9fiB3EoB/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
      - $CI_COMMIT_REF_NAME/coverage

test_Base:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_base
  dependencies:
    - docker_build_bim2sim:base:dev
  variables:
    IMAGE_NAME: "base_dev"
  extends: .test_base
  rules:
    - !reference [ .docker_build_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_dev/
      when: on_success

test_Base:main:
  image: ${TEST_IMAGE}
  stage: test_docker_base
  dependencies:
    - docker_build_bim2sim:base:main
  variables:
    IMAGE_NAME: "base"
  extends: .test_base
  rules:
    - !reference [ .docker_build_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_main/
      when: on_success

test_Base:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_base
  dependencies:
    - docker_build_bim2sim:base:nightly
  variables:
    IMAGE_NAME: "base_nightly"
  extends: .test_base
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Build docker Plugins]

.docker_build_rules:plugin:main:
  rules:
     - !reference [.docker_build_rules:main, rules]
     - if: $CI_COMMIT_MESSAGE =~ /ci_build_plugin_main/
       when: on_success

.docker_build_rules:plugin:dev:
  rules:
     - !reference [.docker_build_rules:dev, rules]
     - if: $CI_COMMIT_MESSAGE =~ /ci_build_plugin_dev/
       when: on_success


docker_build_plugin:aixlib:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_aixlib"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_aixlib"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:aixlib:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_aixlib"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_aixlib_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:aixlib:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_aixlib"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_aixlib_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin AixLib]

.test_plugin:AixLib:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/R6K1H5Z9fiB3EoB/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginAixLib/test/integration_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:AixLib:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:main
  variables:
    IMAGE_NAME: "plugin_aixlib"
  extends: .test_plugin:AixLib
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:AixLib:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:dev
  variables:
    IMAGE_NAME: "plugin_aixlib_dev"
  extends: .test_plugin:AixLib
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:AixLib:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:nightly
  variables:
    IMAGE_NAME: "plugin_aixlib_nightly"
  extends: .test_plugin:AixLib
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [build plugin cfd]
docker_build_plugin:cfd:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_cfd"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_cfd"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:cfd:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_cfd"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_cfd_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:cfd:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_cfd"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_cfd_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test plugin cfd]
.test_plugin:cfd:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginCFD/test/integration_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:cfd:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:main
  variables:
    IMAGE_NAME: "plugin_cfd"
  extends: .test_plugin:cfd
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:cfd:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:dev
  variables:
    IMAGE_NAME: "plugin_cfd_dev"
  extends: .test_plugin:cfd
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:cfd:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:nightly
  variables:
    IMAGE_NAME: "plugin_cfd_nightly"
  extends: .test_plugin:cfd
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Build plugin energyplus]

docker_build_plugin:energyplus:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_energyplus"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_energyplus"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:energyplus:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_energyplus"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_energyplus_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:energyplus:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_energyplus"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_energyplus_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test plugin energyplus]
.test_plugin:energyplus:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - cat /bim2sim-coding/bim2sim/plugins/PluginEnergyPlus/data/Minimal.idf
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginEnergyPlus/test/integration_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:energyplus:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin

  dependencies:
    - docker_build_plugin:energyplus:main
  variables:
    IMAGE_NAME: "plugin_energyplus"
  extends: .test_plugin:energyplus
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:energyplus:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:dev
  variables:
    IMAGE_NAME: "plugin_energyplus_dev"
  extends: .test_plugin:energyplus
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:energyplus:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin

  dependencies:
    - docker_build_plugin:energyplus:nightly
  variables:
    IMAGE_NAME: "plugin_energyplus_nightly"
  extends: .test_plugin:energyplus
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

.test_plugin:energyplus_regression:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - cat /bim2sim-coding/bim2sim/plugins/PluginEnergyPlus/data/Minimal.idf
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - wget --quiet -O /bim2sim-coding/bim2sim/assets/download.zip https://rwth-aachen.sciebo.de/s/5EQqe5g8x0x4lae/download
    - unzip /bim2sim-coding/bim2sim/assets/download.zip -d /bim2sim-coding/bim2sim/assets/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginEnergyPlus/test/regression_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:energyplus_regression:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:main
  variables:
    IMAGE_NAME: "plugin_energyplus"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:energyplus_regression:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:dev
  variables:
    IMAGE_NAME: "plugin_energyplus_dev"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]


test_plugin:energyplus_regression:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:nightly
  variables:
    IMAGE_NAME: "plugin_energyplus_nightly"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [build tool hkesim]

docker_build_plugin:hkesim:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_hkesim"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_hkesim"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:hkesim:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_hkesim"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_hkesim_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:hkesim:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_hkesim"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_hkesim_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test tool hkesim]

# [Build plugin lca]

docker_build_plugin:lca:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_lca"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_lca"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:lca:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_lca"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_lca_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:lca:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_lca"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_lca_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test plugin lca]
.test_plugin:lca:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginLCA/test/integration_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:lca:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:lca:main
  variables:
    IMAGE_NAME: "plugin_lca"
  extends: .test_plugin:lca
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:lca:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:lca:dev
  variables:
    IMAGE_NAME: "plugin_lca_dev"
  extends: .test_plugin:lca
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:lca:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:lca:nightly
  variables:
    IMAGE_NAME: "plugin_lca_nightly"
  extends: .test_plugin:lca
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [build plugin teaser]
docker_build_plugin:teaser:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_teaser"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules]

docker_build_plugin:teaser:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_teaser_dev"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:teaser:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_teaser_nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test plugin teaser
.test_plugin:teaser:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginTEASER/test/integration_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:teaser:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:main
  variables:
    IMAGE_NAME: "plugin_teaser"
  extends: .test_plugin:teaser
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:teaser:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:dev
  variables:
    IMAGE_NAME: "plugin_teaser_dev"
  extends: .test_plugin:teaser
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:teaser:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:nightly
  variables:
    IMAGE_NAME: "plugin_teaser_nightly"
  extends: .test_plugin:teaser
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [build docker dymola]

.docker_dymola_build:
  image: docker@sha256:c8bb6fa5388b56304dd770c4bc0478de81ce18540173b1a589178c0d31bfce90
  services:
      - name: docker:18.09.7-dind
        command: [ "--mtu=1440" ]
  before_script:
    - docker login -u $CI_DEPLOY_TOKEN_USERNAME_DYMOLA -p $CI_DEPLOY_TOKEN_PASSWORD_DYMOLA $CI_REGISTRY_LOGIN_DYMOLA
  script:
    - docker build --pull --build-arg BIM2SIM_FLAG=$BIM2SIM_FLAG --build-arg BIM2SIM_NAME=$BIM2SIM_NAME --build-arg BIM2SIM_VERSION=$BIM2SIM_VERSION -t $TEST_IMAGE -f $DOCKERPATH .
    - docker login -u $CI_DEPLOY_TOKEN_USERNAME -p $CI_DEPLOY_TOKEN_PASSWORD $CI_REGISTRY_LOGIN  # login bim2sim reg
    - docker images
    - docker push $TEST_IMAGE

# [build docker dymola bim2sim base]
docker_build_bim2sim:env_dymola_base:dev:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "dymola_dev"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_dev/
      when: on_success

docker_build_bim2sim:env_dymola_base:main:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "dymola"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_main/
      when: on_success

docker_build_bim2sim:env_dymola_base:nightly:
  stage: build_docker_base
  variables:
    BIM2SIM_NAME: "bim2sim_base"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "dymola_nightly"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# Todo [test docker dymola bim2sim base]


# [build docker dymola plugin teaser]

docker_build_plugin:dymola_teaser:main:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "plugin_dymola_teaser"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:plugin:main, rules ]

docker_build_plugin:dymola_teaser:dev:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "plugin_dymola_teaser_dev"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:plugin:dev, rules]

docker_build_plugin:dymola_teaser:nightly:
  stage: build_docker_plugin
  variables:
    BIM2SIM_NAME: "bim2sim_teaser"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "plugin_dymola_teaser_nightly"
    DOCKERPATH: "docker/basic_build/envBaseDymola.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [test docker dymola plugin teaser]

.test_plugin:TEASER_regression:
  before_script:
    - pip install coverage
    - pip install coverage-badge
  script:
    - mv ./* /bim2sim-coding/
    - cd /bim2sim-coding
    - wget --quiet -O /bim2sim-coding/test/TestModels/download.zip https://rwth-aachen.sciebo.de/s/SAUQQgvwqeS96ix/download
    - unzip /bim2sim-coding/test/TestModels/download.zip -d /bim2sim-coding/test/TestModels/
    - wget --quiet -O /bim2sim-coding/bim2sim/assets/download.zip https://rwth-aachen.sciebo.de/s/5EQqe5g8x0x4lae/download
    - unzip /bim2sim-coding/bim2sim/assets/download.zip -d /bim2sim-coding/bim2sim/assets/
    - git clone --branch development https://github.com/RWTH-EBC/AixLib.git /bim2sim-coding/AixLib
    - xvfb-run -n 77 coverage run -m unittest discover /bim2sim-coding/bim2sim/plugins/PluginTEASER/test/regression_test
    - coverage report -i
    - mkdir -p $CI_COMMIT_REF_NAME/coverage
    - coverage html -i
    - cp htmlcov/* $CI_COMMIT_REF_NAME/coverage/
  artifacts:
    paths:
    - $CI_COMMIT_REF_NAME/coverage

test_plugin:dymola_teaser:main:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:main
  variables:
    IMAGE_NAME: "plugin_dymola_teaser"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [ .docker_build_rules:plugin:main, rules ]

test_plugin:dymola_teaser:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:dev
  variables:
    IMAGE_NAME: "plugin_dymola_teaser_dev"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [ .docker_build_rules:plugin:dev, rules ]

test_plugin:dymola_teaser:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:nightly
  variables:
    IMAGE_NAME: "plugin_dymola_teaser_nightly"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [.docker_build_rules:nightly, rules ]


# [build docker bim2sim total]

docker_build_total:main:
  stage: build_docker_total
  variables:
    BIM2SIM_NAME: "bim2sim"
    BIM2SIM_FLAG: ""
    IMAGE_NAME: "latest"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

docker_build_total:dev:
  stage: build_docker_total
  variables:
    BIM2SIM_NAME: "bim2sim"
    BIM2SIM_FLAG: ".dev"
    IMAGE_NAME: "development"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

docker_build_total:nightly:
  stage: build_docker_total
  variables:
    BIM2SIM_NAME: "bim2sim"
    BIM2SIM_FLAG: ".nightly"
    IMAGE_NAME: "nightly"
    DOCKERPATH: "docker/basic_build/envBase.Dockerfile"
  extends: .docker_dymola_build
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [base test]
test_bim2sim:base:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_base
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:base:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_base
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:base:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_base
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin AixLib]
test_bim2sim:plugin:aixlib:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:AixLib
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:aixlib:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:AixLib
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:aixlib:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:AixLib
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin cfd]
test_bim2sim:plugin:cfd:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:cfd
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:cfd:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:cfd
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:cfd:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:cfd
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin energyplus]
test_bim2sim:plugin:energyplus:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:energyplus
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:energyplus:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:energyplus
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:energyplus:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:energyplus
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin energyplus_regression]
test_bim2sim:plugin:energyplus_regression:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:energyplus_regression:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:energyplus_regression:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:energyplus_regression
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin lca]
test_bim2sim:plugin:lca:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:lca
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:lca:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:lca
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:lca:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:lca
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin lca]
test_bim2sim:plugin:teaser:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:teaser
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:teaser:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:teaser
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:teaser:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:teaser
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Test plugin TEASER_regression]
test_bim2sim:plugin:TEASER_regression:main:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [.docker_build_rules:main, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: on_success

test_bim2sim:plugin:TEASER_regression:dev:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [.docker_build_rules:dev, rules]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: on_success

test_bim2sim:plugin:TEASER_regression:nightly:
  image: ${TEST_IMAGE}
  stage: test_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .test_plugin:TEASER_regression
  rules:
    - !reference [.docker_build_rules:nightly, rules]

# [Release]

.docker_release_rules:main:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_main/
      when: manual
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_docker_main/
      when: manual

.docker_release_rules:dev:
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_dev/
      when: manual
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_docker_dev/
      when: manual

.docker_release_rules:plugin:main:
  rules:
     - !reference [.docker_release_rules:main, rules]
     - if: $CI_COMMIT_MESSAGE =~ /ci_build_plugin_main/
       when: manual

.docker_release_rules:plugin:dev:
  rules:
     - !reference [.docker_release_rules:dev, rules]
     - if: $CI_COMMIT_MESSAGE =~ /ci_build_plugin_dev/
       when: manual

.docker_release:
  image: docker:latest
  services:
      - name: docker:18.09.7-dind
        command: [ "--mtu=1440" ]
  script:
    - docker pull $TEST_IMAGE
    - docker tag $TEST_IMAGE $RELEASE_IMAGE
    - docker push $RELEASE_IMAGE

# [Release bim2sim base]
docker_release_bim2sim:base:main:
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:base:main
  variables:
    IMAGE_NAME: "base"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_main/
      when: manual

docker_release_bim2sim:env_base:dev:
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:base:dev
  variables:
    IMAGE_NAME: "base_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_dev/
      when: manual

docker_release_bim2sim:env_base:nightly:
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:base:nightly
  variables:
    IMAGE_NAME: "base_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim aixlib plugin]

docker_release_plugin:aixlib:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:main
  variables:
    IMAGE_NAME: "plugin_aixlib"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:aixlib:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:dev
  variables:
    IMAGE_NAME: "plugin_aixlib_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:aixlib:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:aixlib:nightly
  variables:
    IMAGE_NAME: "plugin_aixlib_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim cfd plugin]

docker_release_plugin:cfd:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:main
  variables:
    IMAGE_NAME: "plugin_cfd"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:cfd:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:dev
  variables:
    IMAGE_NAME: "plugin_cfd_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:cfd:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:cfd:nightly
  variables:
    IMAGE_NAME: "plugin_cfd_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim energyplus plugin]
docker_release_plugin:energyplus:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:main
  variables:
    IMAGE_NAME: "plugin_energyplus"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:energyplus:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:dev
  variables:
    IMAGE_NAME: "plugin_energyplus_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]


docker_release_plugin:energyplus:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:energyplus:nightly
  variables:
    IMAGE_NAME: "plugin_energyplus_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim hkesim plugin]
docker_release_plugin:hkesim:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:hkesim:main
  variables:
    IMAGE_NAME: "plugin_hkesim"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:hkesim:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:hkesim:dev
  variables:
    IMAGE_NAME: "plugin_hkesim_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:hkesim:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:hkesim:nightly
  variables:
    IMAGE_NAME: "plugin_hkesim_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim lca plugin]
docker_release_plugin:lca:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:lca:main
  variables:
    IMAGE_NAME: "plugin_lca"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:lca:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:lca:dev
  variables:
    IMAGE_NAME: "plugin_lca_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:lca:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:lca:nightly
  variables:
    IMAGE_NAME: "plugin_lca_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [Release bim2sim teaser plugin]

docker_release_plugin:teaser:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:main
  variables:
    IMAGE_NAME: "plugin_teaser"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:teaser:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:dev
  variables:
    IMAGE_NAME: "plugin_teaser_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:teaser:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:teaser:nightly
  variables:
    IMAGE_NAME: "plugin_teaser_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [dymola docker release]

docker_release:env_dymola_base:main:
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:env_dymola_base:main
  variables:
    IMAGE_NAME: "dymola"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_main/
      when: manual

docker_release:env_dymola_base:dev:
  extends: .docker_release
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:env_dymola_base:dev
  variables:
    IMAGE_NAME: "dymola_dev"
  rules:
    - !reference [.docker_release_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_base_dev/
      when: manual

docker_release:env_dymola_base:nightly:
  extends: .docker_release
  stage: release_docker_base
  dependencies:
    - docker_build_bim2sim:env_dymola_base:nightly
  variables:
    IMAGE_NAME: "dymola_nightly"
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [dymola teaser docker release]

docker_release_plugin:dymola_teaser:main:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:main
  variables:
    IMAGE_NAME: "plugin_dymola_teaser"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:main, rules ]

docker_release_plugin:dymola_teaser:dev:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:dev
  variables:
    IMAGE_NAME: "plugin_dymola_teaser_dev"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:plugin:dev, rules ]

docker_release_plugin:dymola_teaser:nightly:
  stage: release_docker_plugin
  dependencies:
    - docker_build_plugin:dymola_teaser:nightly
  variables:
    IMAGE_NAME: "plugin_dymola_teaser_nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]

# [dymola teaser docker release]

docker_release_total:main:
  stage:  release_docker_total
  dependencies:
    - docker_build_total:main
  variables:
    IMAGE_NAME: "latest"
  extends: .docker_release
  rules:
    - !reference [ .docker_release_rules:main, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_main/
      when: manual

docker_release_total:dev:
  stage:  release_docker_total
  dependencies:
    - docker_build_total:dev
  variables:
    IMAGE_NAME: "development"
  extends: .docker_release
  rules:
    - !reference [.docker_release_rules:dev, rules ]
    - if: $CI_COMMIT_MESSAGE =~ /ci_build_total_dev/
      when: manual

docker_release_total:nightly:
  stage:  release_docker_total
  dependencies:
    - docker_build_total:nightly
  variables:
    IMAGE_NAME: "nightly"
  extends: .docker_release
  rules:
    - !reference [.docker_build_rules:nightly, rules ]
